<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Focus · Proves (Mestre/Alumne)</title>
<meta name="description" content="Crea proves, publica al servidor i accedeix per PIN. Resultats centralitzats." />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
  onload="window.__katexReady=true"></script>
<style>
  :root{
    --bg:#f7f7fb; --card:#fff; --ink:#0f172a; --muted:#64748b;
    --p1:#7aa2ff; --p2:#22c55e; --bad:#ef4444; --hair:#e5e7eb;
    --shadow:0 12px 28px rgba(15,23,42,.10); --radius:18px;
    --focus:0 0 0 3px rgba(122,162,255,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    background:linear-gradient(180deg,#f7f7fb, #f1f5ff 35%, #f7f7fb 70%);
    color:var(--ink)
  }
  header{position:sticky; top:0; z-index:5; background:rgba(255,255,255,.8); backdrop-filter: blur(8px); border-bottom:1px solid var(--hair)}
  .wrap{max-width:1200px; margin:0 auto; padding:14px 16px;}
  .row{display:flex; align-items:center; gap:14px; justify-content:space-between}
  .brand{display:flex; align-items:center; gap:12px}
  .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:#fff;box-shadow:var(--shadow);font-weight:900}
  h1{font-size:18px; margin:0}
  nav .pill{border:none; padding:10px 14px; border-radius:999px; background:#fff; box-shadow:var(--shadow); cursor:pointer; font-weight:600}
  nav .pill.active{background:var(--p1); color:#fff}
  main{max-width:1200px; margin:24px auto; padding:0 16px 48px}
  .grid{display:grid; gap:16px}
  @media(min-width:960px){ .grid-2{grid-template-columns: 2fr 1.2fr} }
  .card{background:var(--card); border:1px solid var(--hair); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
  .title{font-size:18px; font-weight:800; margin:0 0 8px}
  .muted{color:var(--muted); font-size:14px; margin:0 0 16px}
  label{display:block; font-weight:700; margin:12px 0 6px}
  input[type="text"], input[type="number"], textarea, select{
    width:100%; padding:10px 12px; border:1px solid var(--hair); border-radius:12px; font-size:16px; background:#fff;
  }
  textarea{min-height:88px; resize:vertical}
  .row-inline{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .btn{appearance:none; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; background:var(--p1); color:#fff; box-shadow:var(--shadow)}
  .btn.secondary{background:#fff; color:#0f172a; border:1px solid var(--hair)}
  .btn.good{background:var(--p2); color:#073b14}
  .btn.bad{background:#fff; color:#b91c1c; border:1px solid #fecaca}
  .btn.small{padding:6px 10px; font-weight:600; border-radius:10px}
  .badge{display:inline-block; padding:4px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:12px}
  .q-item{border:1px dashed var(--hair); border-radius:14px; padding:12px; margin:10px 0; background:#fafbff}
  .hr{height:1px; background:var(--hair); margin:12px 0}
  .flex{display:flex; gap:10px; flex-wrap:wrap}
  .table{width:100%; border-collapse: collapse; background:#fff; border-radius:12px; overflow:hidden; border:1px solid var(--hair)}
  .table th, .table td{padding:10px 12px; border-bottom:1px solid var(--hair); text-align:left; font-size:14px; vertical-align:top}
  .table th{background:#f8fafc; font-size:12px; text-transform:uppercase; letter-spacing:.03em}
  .help{font-size:13px; color:#475569}
  .right{margin-left:auto}
  .success{color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; padding:8px 10px; border-radius:10px; display:inline-block}
  .warn{color:#92400e; background:#fffbeb; border:1px solid #fde68a; padding:8px 10px; border-radius:10px; display:inline-block}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .pill-tab{display:inline-flex; gap:6px; border:1px solid var(--hair); border-radius:999px; padding:4px; background:#fff}
  .pill-tab button{border:none; background:none; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700}
  .pill-tab button.active{background:#eef2ff}

  /* ===== Mestre: layout nou ===== */
  .tabs{display:flex; gap:8px; margin-bottom:12px}
  .tab-btn{border:none; background:#fff; border:1px solid var(--hair); border-radius:999px; padding:10px 14px; cursor:pointer; font-weight:800}
  .tab-btn.active{background:var(--p1); color:#fff}
  .tab-content{display:none}
  .tab-content.active{display:block}

  .teacher-topbar{
    display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    background:#fff; border:1px solid var(--hair); border-radius:14px; padding:12px; box-shadow:var(--shadow);
  }

  /* ===== Estil millorats per a l'editor ===== */
  .editor-grid{
    display:grid; gap:20px; grid-template-columns: 280px minmax(0,1fr) 340px;
  }
  @media(max-width:1100px){ .editor-grid{ grid-template-columns: 1fr; } }

  .sidebar{
    background:#fff; border:1px solid var(--hair); border-radius:18px; padding:16px; box-shadow:var(--shadow);
    max-height:600px; overflow:auto;
  }
  .q-list-item{
    padding:14px; border-radius:14px;
    display:flex; align-items:center; gap:12px; margin-bottom:12px;
    cursor:pointer; transition:all 0.2s;
  }
  .q-list-item:hover{ transform:translateX(2px); box-shadow:0 2px 8px rgba(0,0,0,.08); }
  .q-list-item.active{ outline:var(--focus); background:#eef2ff; }
  .q-icon{width:36px; height:36px; border-radius:50%; display:grid; place-items:center; font-weight:700; color:#fff; font-size:12px;}
  .q-mc{background:#3b82f6;}
  .q-tf{background:#22c55e;}
  .q-short{background:#a855f7;}
  .q-num{background:#f97316;}
  .q-long{background:#64748b;}
  .q-order{background:#eab308;}
  .q-match{background:#06b6d4;}
  .q-title{font-weight:600; font-size:14px;}
  .q-meta{font-size:12px; color:#475569;}

  .editor{
    background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:20px;
  }
  .editor h3{margin-top:0;}
  .section{margin-bottom:20px;}
  .section h4{margin:0 0 8px; font-size:15px; color:#334155; border-bottom:1px solid #e2e8f0; padding-bottom:4px;}
  textarea, input[type="text"], input[type="number"]{
    width:100%; padding:10px 12px;
    border:1px solid #cbd5e1; border-radius:12px; font-size:14px; margin-bottom:10px;
  }
  textarea:focus, input:focus{outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.2);}
  .pill-btn{background:#f1f5f9; border:none; border-radius:999px; padding:8px 16px; margin-top:10px; font-weight:600; cursor:pointer; transition:background .2s;}
  .pill-btn:hover{background:#e2e8f0;}

  .preview{
    background:#f9fafb; border-radius:18px; box-shadow:inset 0 0 0 1px #e2e8f0; padding:20px;
  }
  .q-item{background:#fff; border:1px solid #e2e8f0; border-radius:14px; padding:14px; margin-bottom:14px;}
  .q-item h4{margin:0 0 10px; font-size:16px;}
  .option{padding:10px 12px; margin-bottom:8px; border-radius:12px; background:#f1f5f9;}
  .option.tf-true{background:#dcfce7; color:#166534;}
  .option.tf-false{background:#fee2e2; color:#991b1b;}
  .order-item,.match-item{padding:8px; background:#f1f5f9; border-radius:10px; margin-bottom:6px;}

  /* === Toolbar millorada === */
  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .tool {
    border: none;
    border-radius: 999px;
    padding: 8px 16px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    color: #1e293b;
  }
  .tool:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,.1);
  }
  .tool.mc     { background:#dbeafe; color:#1e40af; }
  .tool.tf     { background:#dcfce7; color:#166534; }
  .tool.short  { background:#f3e8ff; color:#6b21a8; }
  .tool.num    { background:#ffedd5; color:#9a3412; }
  .tool.long   { background:#f1f5f9; color:#334155; }
  .tool.order  { background:#fef9c3; color:#854d0e; }
  .tool.match  { background:#cffafe; color:#0e7490; }
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="brand">
      <div class="logo" aria-hidden="true">FQ</div>
      <h1>Focus · Proves</h1>
      <span class="badge">PIN via servidor</span>
    </div>
    <nav class="right">
      <button class="pill" id="btnHome" onclick="showView('home')">Inici</button>
      <button class="pill" id="btnTeacher" onclick="askTeacherCode()">Mestre</button>
      <button class="pill" id="btnStudent" onclick="enterRole('student')">Alumne</button>
      <button class="pill" id="btnFQ" onclick="window.location.href='https://focusquiz.netlify.app/'">FQ</button>
    </nav>
  </div>
</header>

<main>
  <!-- HOME -->
  <section id="view-home" class="grid">
    <div class="card">
      <h2 class="title">Com funciona</h2>
      <p class="muted">El/la mestre/a crea una prova i la <strong>publica al servidor</strong>. El servidor retorna un <strong>PIN</strong>. L’alumne entra el PIN i fa la prova. Els resultats es guarden al servidor.</p>
      <div class="flex">
        <button class="btn" onclick="askTeacherCode()">Sóc Mestre</button>
        <button class="btn secondary" onclick="enterRole('student')">Sóc Alumne</button>
      </div>
    </div>
  </section>

  <!-- TEACHER (RENOVAT) -->
  <section id="view-teacher" style="display:none">
    <div class="wrap" style="padding:0">
      <!-- TOPBAR -->
      <div class="teacher-topbar">
        <div style="flex:1; min-width:260px">
          <label for="examTitle" style="margin-top:0">Títol de la prova</label>
          <input id="examTitle" type="text" placeholder="Ex: Comprensió lectora · 4t" oninput="lazySaveExam(); markDirty()" />
        </div>
        <div>
  <label for="examSubject" style="margin-top:0">Assignatura</label>
  <select id="examSubject" onchange="lazySaveExam(); markDirty()">
    <option value="">— Selecciona —</option>
    <option value="català">Català</option>
    <option value="castellà">Castellà</option>
    <option value="anglès">Anglès</option>
    <option value="mates">Matemàtiques</option>
    <option value="fisica">Física</option>
    <option value="quimica">Química</option>
    <option value="historia">Història</option>
    <option value="biologia">Biologia</option>
    <!-- Pots ampliar segons vulguis -->
  </select>
      </div>
        <div>
          <label for="examShowScore" style="margin-top:0">Mostrar nota a l’alumne?</label>
          <select id="examShowScore" onchange="lazySaveExam(); markDirty()">
            <option value="yes">Sí</option>
            <option value="no">No</option>
          </select>
        </div>
        <div class="row-inline" style="align-items:center">
          <label style="margin:0">
            <input type="checkbox" id="examShuffle" onchange="toggleShuffle(this.checked); markDirty()" />
            <span class="help">Barrejar preguntes</span>
          </label>
        </div>
        <div class="right row-inline">
          <span class="mini">Estat:</span>
          <span id="saveDot" class="status-dot ok" title="Desat"></span>
          <button class="btn bad" onclick="clearExam()">Buida</button>
          <button class="btn good" onclick="publishExam()">Publica</button>
        </div>
      </div>

      <div class="hr"></div>

      <!-- SUB-TABS -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="tab-editor" onclick="switchTab(this)">Editor</button>
        <button class="tab-btn" data-tab="tab-library" onclick="switchTab(this)">Biblioteca</button>
        <button class="tab-btn" data-tab="tab-results" onclick="switchTab(this)">Resultats</button>
      </div>

      <!-- EDITOR TAB -->
      <div id="tab-editor" class="tab-content active">
        <div class="editor-grid">
          <!-- SIDEBAR -->
          <aside class="sidebar">
            <div class="row-inline" style="justify-content:space-between; margin-bottom:8px">
              <strong>Preguntes</strong>
              <span id="qCount" class="mini"></span>
            </div>
            <div class="toolbar" style="margin-bottom:10px">
              <button class="tool mc" onclick="addQuestion('mc')">+ Opció múltiple</button>
              <button class="tool tf" onclick="addQuestion('tf')">V/F</button>
              <button class="tool short" onclick="addQuestion('short')">Curta</button>
              <button class="tool num" onclick="addQuestion('num')">Num</button>
              <button class="tool long" onclick="addQuestion('long')">Llarga</button>
              <button class="tool order" onclick="addQuestion('order')">Ordena</button>
              <button class="tool match" onclick="addQuestion('match')">Match</button>
            </div>
            <div id="qList"></div>
            <div class="hr"></div>
            <label for="examDesc">Instruccions per a l’alumnat</label>
            <textarea id="examDesc" placeholder="Llegeix atentament i respon." oninput="lazySaveExam(); markDirty()"></textarea>
            <p id="publishInfo" class="help" style="margin-top:10px"></p>
          </aside>

          <!-- EDITOR CENTRAL -->
          <section class="editor">
            <h3 class="title" style="margin-bottom:8px">Editor de la pregunta</h3>
            <div id="qEditor" class="muted">Selecciona una pregunta o crea’n una de nova.</div>
          </section>

          <!-- PREVIEW -->
          <aside class="preview">
            <h3 class="title">Previsualització</h3>
            <div id="qPreview" class="help">Cap pregunta seleccionada.</div>
          </aside>
        </div>
      </div>

      <!-- LIBRARY TAB -->
<div id="tab-library" class="tab-content">
  <div class="card">
    <h3 class="title">Biblioteca d’exàmens</h3>
    <p class="muted">Exàmens guardats al servidor per reutilitzar-los o clonar-los amb un nou PIN.</p>
    <div class="row-inline">
      <input id="libSearch" type="text" placeholder="Cerca..." oninput="listExams()" />
<select id="libSubjectFilter" onchange="listExams()">
        <option value="">Totes les assignatures</option>
        <option value="català">Català</option>
        <option value="castellà">Castellà</option>
        <option value="anglès">Anglès</option>
        <option value="mates">Matemàtiques</option>
        <option value="fisica">Física</option>
        <option value="quimica">Química</option>
        <option value="historia">Història</option>
        <option value="biologia">Biologia</option>
      </select>
      <button class="btn small" id="libRefreshBtn" onclick="listExams()">Actualitza</button>
    </div>
    <div class="hr"></div>
    <div style="max-height:420px; overflow:auto; margin-top:10px">
      <table class="table" id="libraryTable"></table>
    </div>
    <p id="libraryInfo" class="help"></p>
  </div>
</div>


      <!-- RESULTS TAB -->
      <div id="tab-results" class="tab-content">
        <div class="card">
          <h3 class="title">Resultats (del servidor)</h3>
          <p class="muted">Consulta els resultats per a l’<strong>examId</strong> que rebràs en publicar.</p>
          <label for="examIdLookup">examId</label>
          <input id="examIdLookup" type="text" placeholder="Ex: 9f3a2b1c..." />
          <div class="flex">
            <button class="btn small" onclick="fetchResults()">Carrega resultats</button>
            <button class="btn small secondary" onclick="downloadCSV()">Descarrega CSV</button>
            <button class="btn small secondary" onclick="loadExamById(($('#examIdLookup').value||'').trim())">Carrega a l’editor</button>
          </div>
          <div class="hr"></div>
          <div id="aggSummary" class="help" style="margin-top:10px"></div>
          <div style="max-height:420px; overflow:auto; margin-top:10px">
            <table class="table" id="resultsTable"></table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STUDENT (es conserva) -->
  <section id="view-student" class="grid grid-2" style="display:none">
    <div class="card">
      <h2 class="title">Accés amb PIN</h2>
      <p class="muted">Introdueix el <strong>PIN</strong> que t’ha donat el/la mestre/a per carregar la prova des del servidor.</p>
      <label for="pinInput">PIN (6 dígits)</label>
      <input id="pinInput" type="text" placeholder="Ex: 482917" />
      <div class="flex">
        <button class="btn small" onclick="loadExamByPin()">Carrega prova</button>
      </div>
      <p id="loadStatus" class="help"></p>

      <div class="hr"></div>
      <h3 class="title">Identificació</h3>
      <label for="studentName">Nom i cognoms</label>
      <input id="studentName" type="text" placeholder="Ex: Marta Puig" />
      <label for="studentGroup">Grup / Classe</label>
<select id="studentGroup">
  <option value="Acadèmia">Acadèmia</option>
  <option value="Arnau Cadell">Arnau Cadell</option>
</select>
      <button class="btn" onclick="startExam()">Començar</button>
    </div>

    <div class="card">
      <h3 class="title">Detalls de la Prova</h3>
      <div id="examDetails" class="help">Encara no hi ha cap prova carregada.</div>
    </div>
  </section>

  <!-- DO EXAM -->
  <section id="view-do" class="grid" style="display:none">
    <div class="card">
      <h2 class="title" id="doTitle">Prova</h2>
      <p class="muted" id="doDesc"></p>
      <div id="doQuestions"></div>
      <div class="hr"></div>
      <button class="btn good" onclick="submitExam()">Enviar respostes</button>
      <span id="doNotice" class="help"></span>
    </div>
  </section>

  <!-- RESULT -->
  <section id="view-result" class="grid" style="display:none">
    <div class="card center">
      <h2 class="title">Resultats enviats</h2>
      <p class="muted" id="studentScoreInfo"></p>
      <div class="flex center" style="justify-content:center">
        <button class="btn secondary" onclick="showView('student')">Tornar</button>
      </div>
    </div>
  </section>
</main>
<script>
/* ========= Config ========= */
const API_BASE = ''; // mateix host (reverse proxy / estàtic). Si cal: 'http://localhost:3000'

/* ========= Utils ========= */
const $ = sel => document.querySelector(sel);
function showView(id){
  for(const el of document.querySelectorAll('main > section')) el.style.display='none';
  $('#view-'+id).style.display='';
  for(const b of document.querySelectorAll('nav .pill')) b.classList.remove('active');
  if(id==='home') $('#btnHome').classList.add('active');
  if(id==='teacher'){ $('#btnTeacher').classList.add('active'); listExams(); }
  if(id==='student' || id==='do' || id==='result') $('#btnStudent').classList.add('active');
}
  function askTeacherCode(){
  // si ja està validat en aquesta sessió, no tornar a demanar
  if(sessionStorage.getItem('teacherAuth') === 'ok'){
    enterRole('teacher');
    return;
  }

  const code = prompt('Introdueix el codi de mestre:');
  if(code === '123'){
    sessionStorage.setItem('teacherAuth', 'ok'); // guarda que ja s’ha autenticat
    enterRole('teacher');
  } else {
    alert('Codi incorrecte');
  }
}
function enterRole(role){ showView(role==='teacher'?'teacher':'student'); }
function uid(){ return Math.random().toString(36).slice(2,10); }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function tryRenderKatex(root){
  if(!window.__katexReady || !window.renderMathInElement) return;
  try{
    window.renderMathInElement(root || document.body, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false}
      ],
      throwOnError:false
    });
  }catch(_){}
}
const toast = (msg)=>{ const d=document.createElement('div'); d.className='success'; d.style.position='fixed'; d.style.right='18px'; d.style.bottom='18px'; d.textContent=msg; document.body.appendChild(d); setTimeout(()=>d.remove(), 1800); };
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function escapeAttr(s){ return String(s||'').replaceAll('"','&quot;'); }
function formatDate(s){ try{ return new Date(s).toLocaleString(); }catch(_){ return s||''; } }

/* ========= Estat i model ========= */
let exam = { id:null, subject:'', title:'', desc:'', settings:{showScoreToStudent:true, shuffle:false}, questions:[] };
let selectedQId = null;
let dirty = false;
function markDirty(){ dirty = true; $('#saveDot').classList.remove('ok'); $('#saveDot').classList.add('dirty'); }

/* ===== Imatge (compressió) ===== */
function compressImage(file, maxW=1400, maxH=1400, quality=0.85){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e=>{
      const img = new Image();
      img.onload = ()=>{
        let {width:w, height:h} = img;
        const ratio = Math.min(maxW/w, maxH/h, 1);
        const cw = Math.round(w*ratio), ch = Math.round(h*ratio);
        const canvas = document.createElement('canvas');
        canvas.width = cw; canvas.height = ch;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0,cw,ch);
        try{ resolve(canvas.toDataURL('image/jpeg', quality)); }
        catch(err){ reject(err); }
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
async function loadMedia(qid, file){
  if(!file) return;
  try{
    const data = await compressImage(file);
    const q=exam.questions.find(x=>x.id===qid); if(!q) return;
    q.media = q.media || {};
    q.media.imgData = data;
    renderAll(); markDirty();
  }catch(e){ alert('No s’ha pogut carregar la imatge.'); }
}

/* ========= Persistència ========= */
function lazySaveExam(){ saveExam(false); }
function saveExam(feedback=false){
  exam.title = $('#examTitle').value.trim();
  exam.desc = $('#examDesc').value.trim();
  exam.subject = $('#examSubject').value || ''; 
  exam.settings.showScoreToStudent = $('#examShowScore').value==='yes';
  localStorage.setItem('focusSrv_exam', JSON.stringify(exam));
  dirty = false; $('#saveDot').classList.remove('dirty'); $('#saveDot').classList.add('ok');
  if(feedback) toast('Prova desada localment.');
}
function toggleShuffle(v){
  exam.settings.shuffle = !!v;
  localStorage.setItem('focusSrv_exam', JSON.stringify(exam));
  markDirty();
}
function clearExam(){
  if(confirm('Vols buidar la prova actual?')){
    exam = { id:null, title:'', desc:'', settings:{showScoreToStudent:true, shuffle:false}, questions:[] };
    selectedQId = null;
    $('#examTitle').value=''; $('#examSubject').value=''; $('#examDesc').value=''; $('#examShowScore').value='yes'; $('#examShuffle').checked=false; $('#publishInfo').textContent='';
    renderAll(); markDirty();
  }
}

/* ========= PESTANYES ========= */
function switchTab(btn){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const id = btn.getAttribute('data-tab');
  document.querySelectorAll('.tab-content').forEach(p=>p.classList.remove('active'));
  $('#'+id).classList.add('active');
  if(id==='tab-library') listExams();
}

/* ========= Preguntes ========= */
function baseQuestion(type){
  const q = { id: uid(), type, text:'', points:1, tags:[], media:{} };
  if(type==='mc'){ q.options=[{text:'Opció 1', correct:false},{text:'Opció 2', correct:true}]; }
  if(type==='tf'){ q.options=[{text:'Vertader', correct:true},{text:'Fals', correct:false}]; }
  if(type==='short'){ q.answerText=''; q.accepts=[]; }
  if(type==='num'){ q.numAnswer=''; q.tolerance='0'; }
  if(type==='long'){ q.rubric='Criteris d’avaluació (opcional)'; }
  if(type==='order'){ q.items=['A','B','C']; }
  if(type==='match'){ q.left=['A','B']; q.right=['1','2']; }
  return q;
}
function addQuestion(type){
  const q = baseQuestion(type);
  exam.questions.push(q);
  selectedQId = q.id;
  renderAll(); markDirty();
}
function selectQuestion(id){ selectedQId = id; renderAll(); }
function moveQuestion(qid, dir){
  const i = exam.questions.findIndex(q=>q.id===qid);
  if(i<0) return;
  const j = clamp(i+(dir==='up'?-1:1), 0, exam.questions.length-1);
  if(i===j) return;
  const [q] = exam.questions.splice(i,1);
  exam.questions.splice(j,0,q);
  renderAll(); markDirty();
}
function duplicateQuestion(qid){
  const i = exam.questions.findIndex(q=>q.id===qid);
  if(i<0) return;
  const clone = JSON.parse(JSON.stringify(exam.questions[i]));
  clone.id = uid();
  exam.questions.splice(i+1,0,clone);
  selectedQId = clone.id;
  renderAll(); markDirty();
}
function delQuestion(qid){
  const idx = exam.questions.findIndex(q=>q.id===qid);
  if(idx<0) return;
  exam.questions.splice(idx,1);
  if(selectedQId===qid){
    const next = exam.questions[idx] || exam.questions[idx-1] || null;
    selectedQId = next ? next.id : null;
  }
  renderAll(); markDirty();
}
function qSet(id, key, val){
  const q=exam.questions.find(x=>x.id===id); if(!q) return;
  if(key==='points') q.points = Number(val)||0;
  else q[key]=val;
  markDirty(); renderPreview();
}

/* ========= Render ========= */
function labelType(t){
  return t==='mc'?'Opció múltiple':
         t==='tf'?'Vertader/Fals':
         t==='short'?'Resposta curta':
         t==='num'?'Numèrica ± tol':
         t==='long'?'Resposta llarga':
         t==='order'?'Ordenar llista':
         t==='match'?'Correspondències': t;
}
function renderSidebar(){
  const list = $('#qList'); list.innerHTML='';
  const cnt = exam.questions.length;
  $('#qCount').textContent = cnt ? `${cnt} preguntes` : 'Cap pregunta';
  exam.questions.forEach((q, i)=>{
    const div = document.createElement('div');
    div.className = 'q-list-item' + (q.id===selectedQId?' active':'');
    div.onclick = ()=>selectQuestion(q.id);
    div.innerHTML = `
      <span class="q-type-badge">Q${i+1}</span>
      <div style="display:flex; flex-direction:column">
        <strong style="font-size:14px">${escapeHtml((q.text||'').slice(0,36) || '(sense enunciat)')}</strong>
        <span class="mini">${labelType(q.type)} · ${q.points||1} pt</span>
      </div>
      <div class="q-actions">
        <button class="icon-btn" title="Pujar" onclick="event.stopPropagation(); moveQuestion('${q.id}','up')">↑</button>
        <button class="icon-btn" title="Baixar" onclick="event.stopPropagation(); moveQuestion('${q.id}','down')">↓</button>
        <button class="icon-btn" title="Duplicar" onclick="event.stopPropagation(); duplicateQuestion('${q.id}')">⎘</button>
        <button class="icon-btn" title="Eliminar" onclick="event.stopPropagation(); delQuestion('${q.id}')">✕</button>
      </div>
    `;
    list.appendChild(div);
  });
}
function renderEditor(){
  const host = $('#qEditor');
  const q = exam.questions.find(x=>x.id===selectedQId);
  if(!q){ host.innerHTML = '<div class="help">Selecciona una pregunta o afegeix-ne una.</div>'; return; }

  // Editors per tipus
  let inner = '';
  if(q.type==='mc' || q.type==='tf'){
    const opts = (q.options||[]).map((o,i)=>`
      <div class="row-inline" style="align-items:center; margin-bottom:6px">
        <input type="radio" name="correct-${q.id}" ${o.correct?'checked':''} onclick="setCorrect('${q.id}', ${i})" />
        <input type="text" value="${escapeAttr(o.text||'')}" oninput="setOptText('${q.id}', ${i}, this.value); markDirty(); renderPreview()" />
        ${q.type==='mc'?`<button class="btn small secondary" onclick="delOpt('${q.id}', ${i})">−</button>`:''}
      </div>
    `).join('');
    const addBtn = q.type==='mc'?`<button class="btn small" onclick="addOpt('${q.id}')">+ Afegir opció</button>`:'';
    inner = `
      <label>Opcions</label>
      <div>${opts}</div>
      ${addBtn}
    `;
  } else if(q.type==='short'){
    inner = `
      <label>Resposta correcta (text)</label>
      <input type="text" value="${escapeAttr(q.answerText||'')}" oninput="qSet('${q.id}','answerText', this.value)" />
      <label>Altres respostes acceptables (separades per ; )</label>
      <input type="text" value="${escapeAttr((q.accepts||[]).join('; '))}" oninput="qSet('${q.id}','accepts', this.value.split(';').map(s=>s.trim()).filter(Boolean))" />
      <p class="help">Correcció tolerant a majúscules/espais.</p>
    `;
  } else if(q.type==='num'){
    inner = `
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:8px">
        <div>
          <label>Resposta numèrica</label>
          <input type="text" value="${escapeAttr(q.numAnswer||'')}" oninput="qSet('${q.id}','numAnswer', this.value)" placeholder="ex: 3.1416" />
        </div>
        <div>
          <label>Tolerància (±)</label>
          <input type="number" step="any" value="${Number(q.tolerance||0)}" oninput="qSet('${q.id}','tolerance', this.value)" />
        </div>
      </div>
    `;
  } else if(q.type==='long'){
    inner = `
      <label>Rúbrica (visible al docent)</label>
      <textarea oninput="qSet('${q.id}','rubric', this.value)">${escapeHtml(q.rubric||'')}</textarea>
      <p class="help">Avaluació manual.</p>
    `;
  } else if(q.type==='order'){
    const items = (q.items||[]).map((t,i)=>`
      <div class="row-inline">
        <input type="text" value="${escapeAttr(t)}" oninput="setOrderItem('${q.id}', ${i}, this.value); markDirty(); renderPreview()" />
        <button class="btn small secondary" onclick="swapOrder('${q.id}', ${i}, -1)">↑</button>
        <button class="btn small secondary" onclick="swapOrder('${q.id}', ${i}, 1)">↓</button>
        <button class="btn small secondary" onclick="delOrderItem('${q.id}', ${i})">−</button>
      </div>
    `).join('');
    inner = `
      <label>Llista en l’ordre correcte</label>
      <div class="options">${items}</div>
      <button class="btn small" onclick="addOrderItem('${q.id}')">+ Afegeix element</button>
      <p class="help">A l’alumne li mostrarem la llista barrejada.</p>
    `;
  } else if(q.type==='match'){
    const left = q.left||[], right = q.right||[];
    inner = `
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:8px">
        <div>
          <label>Llista esquerra</label>
          <textarea oninput="qSet('${q.id}','left', this.value.split('\\n').map(s=>s.trim()).filter(Boolean)); renderPreview()">${escapeHtml(left.join('\n'))}</textarea>
        </div>
        <div>
          <label>Llista dreta</label>
          <textarea oninput="qSet('${q.id}','right', this.value.split('\\n').map(s=>s.trim()).filter(Boolean)); renderPreview()">${escapeHtml(right.join('\n'))}</textarea>
        </div>
      </div>
      <p class="help">La correspondència correcta és per posició (L[0] → R[0], etc.).</p>
    `;
  }

  host.innerHTML = `
    <div class="q-item" style="background:#fff">
      <div class="row-inline" style="justify-content:space-between">
        <span class="mini"><strong>${labelType(q.type)}</strong> · ID: <span class="mono">${q.id}</span></span>
        <div class="row-inline">
          <span class="mini">Punts</span>
          <input type="number" min="0" step="0.5" value="${q.points}" style="width:100px" oninput="qSet('${q.id}','points', this.value)" />
        </div>
      </div>
      <label>Enunciat (admet $\\LaTeX$)</label>
      <textarea oninput="qSet('${q.id}','text', this.value)">${escapeHtml(q.text||'')}</textarea>

      <div class="row-inline" style="align-items:flex-end; gap:16px">
        <div>
          <label>Imatge (opcional)</label>
          <input type="file" accept="image/*" onchange="loadMedia('${q.id}',this.files[0])">
          <p class="help">La imatge es comprimeix automàticament per reduir la mida.</p>
        </div>
        ${q.media?.imgData ? `<img class="img-preview" src="${q.media.imgData}" alt="">` : ''}
      </div>

      <div class="hr"></div>
      ${inner}

      <div class="hr"></div>
      <label>Etiquetes</label>
      <input type="text" value="${(q.tags||[]).join(', ')}" oninput="qSet('${q.id}','tags', this.value.split(',').map(s=>s.trim()).filter(Boolean))" placeholder="ex: mates, fraccions">
    </div>
  `;
  renderPreview();
}
function renderPreview(){
  const host = $('#qPreview'); host.innerHTML='';
  const q = exam.questions.find(x=>x.id===selectedQId);
  if(!q){ host.innerHTML='<div class="help">Cap pregunta seleccionada.</div>'; return; }

  let media = q.media?.imgData ? `<div><img class="img-preview" src="${q.media.imgData}" alt=""></div>` : '';
  let body = '';
  if(q.type==='mc' || q.type==='tf'){
    body = (q.options||[]).map((o,i)=>`
      <label class="row-inline" style="gap:8px;margin-bottom:6px">
        <input type="radio" disabled />
        <span>${escapeHtml(o.text||'')}</span>
      </label>
    `).join('');
  } else if(q.type==='short'){
    body = `<input type="text" disabled placeholder="Resposta curta">`;
  } else if(q.type==='num'){
    body = `<input type="text" disabled placeholder="Ex: 3.14"> <span class="help">± ${q.tolerance||0}</span>`;
  } else if(q.type==='long'){
    body = `<textarea disabled placeholder="Resposta de desenvolupament" style="min-height:120px"></textarea>`;
  } else if(q.type==='order'){
    const items = (q.items||[]).slice().sort(()=>Math.random()-0.5);
    body = items.map(t=>`
      <div class="row-inline"><span class="help" aria-hidden="true">≡</span><input type="text" value="${escapeAttr(t)}" readonly /></div>
    `).join('');
  } else if(q.type==='match'){
    const left = q.left||[], right = (q.right||[]).slice().sort(()=>Math.random()-0.5);
    body = left.map((L)=>`
      <div class="row-inline" style="align-items:center">
        <span style="flex:1">${escapeHtml(L)}</span>
        <select disabled>${right.map(R=>`<option>${escapeHtml(R)}</option>`).join('')}</select>
      </div>
    `).join('');
  }
  host.innerHTML = `
    <div class="q-item">
      <div style="font-weight:700; margin-bottom:6px" class="katex-host">${escapeHtml(q.text||'')}</div>
      ${media}
      ${body}
    </div>
  `;
  tryRenderKatex(host);
}
function renderAll(){ renderSidebar(); renderEditor(); saveExam(false); }

/* ===== Operacions d’opcions i llistes ===== */
function addOpt(qid){ const q=exam.questions.find(x=>x.id===qid); if(q){ q.options.push({text:'Nova opció', correct:false}); renderAll(); markDirty(); } }
function delOpt(qid, i){ const q=exam.questions.find(x=>x.id===qid); if(q){ q.options.splice(i,1); renderAll(); markDirty(); } }
function setCorrect(qid, i){ const q=exam.questions.find(x=>x.id===qid); if(q){ q.options.forEach((o,j)=>o.correct = j===i); markDirty(); renderPreview(); } }
function setOptText(qid, i, v){ const q=exam.questions.find(x=>x.id===qid); if(q){ q.options[i].text=v; markDirty(); renderPreview(); } }
function setOrderItem(qid,i,v){ const q=exam.questions.find(x=>x.id===qid); if(q){ q.items[i]=v; markDirty(); renderPreview(); } }
function addOrderItem(qid){ const q=exam.questions.find(x=>x.id===qid); if(q){ q.items.push('Nou element'); renderAll(); markDirty(); } }
function delOrderItem(qid,i){ const q=exam.questions.find(x=>x.id===qid); if(q){ q.items.splice(i,1); renderAll(); markDirty(); } }
function swapOrder(qid,i,dir){ const q=exam.questions.find(x=>x.id===qid); if(!q) return; const j=clamp(i+dir,0,q.items.length-1); if(i===j) return; [q.items[i],q.items[j]]=[q.items[j],q.items[i]]; renderAll(); markDirty(); }

/* ========= Publicació ========= */
async function publishExam(){
  // Validació
  exam.title = $('#examTitle').value.trim();
  exam.desc = $('#examDesc').value.trim();
  exam.settings.showScoreToStudent = $('#examShowScore').value==='yes';
  if(!exam.title || (exam.questions||[]).length===0){
    alert('Cal un títol i almenys una pregunta.'); return;
  }
  try{
    // ❌ Eliminem _id abans d’enviar al servidor
    const { _id, ...cleanExam } = exam;

    const res = await fetch(API_BASE + '/api/exams', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(cleanExam)
    });
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();

    // ✅ Guardem el _id que genera Mongo
    exam._id = data.examId;

    localStorage.setItem('focusSrv_exam', JSON.stringify(exam));
    $('#publishInfo').innerHTML = `<span class="success">Publicat! PIN: <strong>${data.pin}</strong> &middot; examId: <span class="mono">${data.examId}</span></span>`;
    $('#examIdLookup').value = data.examId;
    toast('Prova publicada');
    listExams();
  }catch(e){
    $('#publishInfo').innerHTML = `<span class="warn">Error en publicar: ${escapeHtml(e.message||'desconegut')}</span>`;
  }
}

/* ========= Alumne (es conserva) ========= */
let loadedExam = null;
let loadedPin = null;
async function loadExamByPin(){
  const pin = ($('#pinInput').value||'').trim(); $('#examSubject').value = exam.subject || '';
  if(!/^\d{6}$/.test(pin)){ 
    alert('Escriu un PIN de 6 dígits.'); 
    return; 
  }
  try{
    const res = await fetch(API_BASE + '/api/exams/pin/' + encodeURIComponent(pin));
    if(!res.ok) throw new Error('PIN no trobat');
    const obj = await res.json();
    
    // ✅ Guardem l’examen i el PIN real que ve del servidor
    loadedExam = obj;
    loadedPin = String(obj.pin); 

    showExamDetails(obj);
    $('#loadStatus').innerHTML = `<span class="success">Prova carregada!</span>`;
  }catch(e){
    $('#loadStatus').innerHTML = `<span class="warn">${escapeHtml(e.message||'No s’ha pogut carregar la prova')}</span>`;
  }
}
function showExamDetails(x){
  $('#examDetails').innerHTML = `
    <div><strong>Títol:</strong> ${escapeHtml(x.title||'')}</div>
    <div><strong>Instruccions:</strong> ${escapeHtml(x.desc||'')}</div>
    <div><strong>Preguntes:</strong> ${x.questions?x.questions.length:0}</div>
    <div><strong>PIN:</strong> ${escapeHtml(x.pin||'(no definit)')}</div>
    <div><strong>examId:</strong> <span class="mono">${escapeHtml(x._id||'')}</span></div>
  `;
}
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

function startExam(){
  if(!loadedExam){ alert('Carrega primer una prova per PIN.'); return; }
  const name = $('#studentName').value.trim();
  const group = $('#studentGroup').value.trim();
  if(!name){ alert('Escriu el teu nom.'); return; }

  const questions = JSON.parse(JSON.stringify(loadedExam.questions||[]));
  if(loadedExam.settings?.shuffle) shuffleArray(questions);

  $('#doTitle').textContent = loadedExam.title||'Prova';
  $('#doDesc').textContent = loadedExam.desc||'';
  const host = $('#doQuestions'); host.innerHTML='';
  questions.forEach((q,idx)=>{
    const el = document.createElement('div'); el.className='q-item';
    let media = '';
    if(q.media?.imgData) media += `<div><img alt="" src="${q.media.imgData}" style="max-width:100%; border:1px solid var(--hair); border-radius:12px; margin:6px 0"></div>`;

    let body='';
    if(q.type==='mc' || q.type==='tf'){
      body = (q.options||[]).map((o,i)=>`
        <label class="row-inline" style="gap:8px;margin-bottom:6px">
          <input type="radio" name="ans-${q.id}" value="${i}" />
          <span>${escapeHtml(o.text)}</span>
        </label>
      `).join('');
    } else if(q.type==='short'){
      body = `<input type="text" id="ans-${q.id}" placeholder="Escriu la resposta" />`;
    } else if(q.type==='num'){
      body = `<input type="text" id="ans-${q.id}" placeholder="Ex: 3.14" /> <span class="help">± ${q.tolerance||0}</span>`;
    } else if(q.type==='long'){
      body = `<textarea id="ans-${q.id}" placeholder="Resposta de desenvolupament" style="min-height:120px"></textarea>`;
    } else if(q.type==='order'){
      const shuffled = [...(q.items||[])]; shuffleArray(shuffled);
      body = `<div id="ord-${q.id}">` + shuffled.map((t,i)=>`
        <div class="row-inline">
          <span class="help" aria-hidden="true">≡</span>
          <input type="text" value="${escapeAttr(t)}" data-i="${i}" readonly />
          <button class="btn small secondary" onclick="ordSwap('${q.id}', ${i}, -1)">↑</button>
          <button class="btn small secondary" onclick="ordSwap('${q.id}', ${i}, 1)">↓</button>
        </div>`).join('') + `</div>`;
      q.__runtimeOrder = shuffled;
    } else if(q.type==='match'){
      const left = q.left||[], right = [...(q.right||[])]; shuffleArray(right);
      const selects = left.map((L,ii)=>`
        <div class="row-inline">
          <span style="min-width:24px">${ii+1}.</span>
          <span style="flex:1">${escapeHtml(L)}</span>
          <select id="match-${q.id}-${ii}">
            ${right.map((R,i)=>`<option value="${i}">${escapeHtml(R)}</option>`).join('')}
          </select>
        </div>`).join('');
      body = `<div>${selects}</div>`;
      q.__runtimeRight = right;
    }

    el.innerHTML = `
      <div class="row-inline" style="justify-content:space-between">
        <div class="mini">Q${idx+1}</div><div class="mini">${q.points||1} punt(s)</div>
      </div>
      <div class="katex-host" style="font-weight:700; margin-bottom:6px">${escapeHtml(q.text||'')}</div>
      ${media}
      ${body}
    `;
    host.appendChild(el);
  });

  tryRenderKatex(host);

  loadedExam.__runtimeOrder = questions.map(q=>q.id);
  loadedExam.__qmap = Object.fromEntries((loadedExam.questions||[]).map(q=>[q.id,q]));
  loadedExam.__rendered = Object.fromEntries(questions.map(q=>[q.id,q]));
  showView('do');
}
function ordSwap(qid,i,dir){
  const wrap = $('#ord-'+qid);
  const rows = Array.from(wrap.querySelectorAll('.row-inline'));
  const j = clamp(i+dir,0,rows.length-1); if(i===j) return;
  if(dir===1) wrap.insertBefore(rows[j], rows[i]);
  else wrap.insertBefore(rows[i], rows[j]);
}

let lastResult = null;
async function submitExam(){
  const answers = [];
  let score = 0, max = 0;

  const ids = loadedExam.__runtimeOrder || (loadedExam.questions||[]).map(q=>q.id);
  const qById = loadedExam.__qmap || Object.fromEntries((loadedExam.questions||[]).map(q=>[q.id,q]));
  const rendered = loadedExam.__rendered || {};

  ids.forEach(id=>{
    const q = qById[id]; 
    const rq = rendered[id] || q;
    max += Number(q.points)||1;

    if(q.type==='mc' || q.type==='tf'){
      const sel = document.querySelector(`input[name="ans-${q.id}"]:checked`);
      const idx = sel ? Number(sel.value) : null;
      const isCorrect = (idx!=null) ? (q.options[idx]?.correct===true) : false;
      if(isCorrect) score += Number(q.points)||1;
      answers.push({qid:q.id, type:q.type, answer: idx!=null ? (q.options[idx]?.text||'') : '', correct:isCorrect});

    } else if(q.type==='short'){
      const val = ($('#ans-'+q.id)?.value||'').trim();
      const norm = s=>String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
      const ok = val ? ([q.answerText||'', ...(q.accepts||[])].some(acc=>norm(acc)===norm(val))) : false;
      if(ok) score += Number(q.points)||1;
      answers.push({qid:q.id, type:q.type, answer: val, correct: ok});

    } else if(q.type==='num'){
      const valRaw = ($('#ans-'+q.id)?.value||'').trim();
      const val = Number(valRaw.replace(',','.'));
      const ans = Number((q.numAnswer||'').toString().replace(',','.'));
      const tol = Number(q.tolerance||0);
      const ok = Number.isFinite(val) && Math.abs(val-ans) <= Math.abs(tol);
      if(ok) score += Number(q.points)||1;
      answers.push({qid:q.id, type:q.type, answer: valRaw, correct: ok});

    } else if(q.type==='long'){
      const val = ($('#ans-'+q.id)?.value||'').trim();
      answers.push({qid:q.id, type:q.type, answer: val, correct: null});

    } else if(q.type==='order'){
      const wrap = $('#ord-'+q.id);
      const got = Array.from(wrap.querySelectorAll('input[type="text"]')).map(i=>i.value);
      const ok = JSON.stringify(got) === JSON.stringify(q.items||[]);
      if(ok) score += Number(q.points)||1;
      answers.push({qid:q.id, type:q.type, answer: got.join(' | '), correct: ok});

    } else if(q.type==='match'){
      const left = q.left||[], right = rq.__runtimeRight || (q.right||[]);
      const picks = left.map((_,i)=>Number(($('#match-'+q.id+'-'+i)?.value||0)));
      let okAll = true;
      left.forEach((_,i)=>{
        const correctR = q.right[i];
        const pickedIdx = picks[i];
        okAll = okAll && (right[pickedIdx]===correctR);
      });
      if(okAll) score += Number(q.points)||1;
      answers.push({qid:q.id, type:q.type, answer: JSON.stringify(picks), correct: okAll});
    }
  });

  const name = $('#studentName').value.trim();
  const group = $('#studentGroup').value.trim();

  lastResult = {
    examId: loadedExam._id,   // 👈 Mongo _id
    pin: String(loadedPin),           // 👈 el PIN que hem guardat a loadExamByPin()
    student:{name, group},
    totals:{score, max},
    responses: answers
  };

  // 👉 DEBUG: veure què enviem
  console.log("Enviant resultat:", {
    examId: loadedExam._id,
    pin: loadedPin,
    expectedPin: loadedExam.pin
  });

  const showScore = loadedExam.settings?.showScoreToStudent !== false;
  $('#studentScoreInfo').innerHTML = showScore ?
    `Has fet <strong>${score}</strong> de <strong>${max}</strong> punts.` :
    `S’han guardat les respostes. El/la mestre/a veurà la teva nota.`;

  try{
    const res = await fetch(API_BASE + '/api/results', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(lastResult)
    });
    if(!res.ok) throw new Error(await res.text());
    showView('result');
  }catch(e){
    alert('No s’ha pogut enviar el resultat: ' + (e.message||''));
  }
}

/* ========= Resultats (mestre) ========= */
async function fetchResults(){
  const examId = ($('#examIdLookup').value||'').trim();
  if(!examId){ alert('Escriu un examId.'); return; }
  try{
    const res = await fetch(API_BASE + '/api/results/' + encodeURIComponent(examId));
    if(!res.ok) throw new Error(await res.text());
    const bag = await res.json();
    renderResultsTable(bag.items||[]);
  }catch(e){
    $('#aggSummary').innerHTML = `<span class="warn">Error: ${escapeHtml(e.message||'')}</span>`;
  }
}
function renderResultsTable(items){
  const tbl = $('#resultsTable');
  if(!items.length){ tbl.innerHTML=''; $('#aggSummary').textContent='Sense resultats.'; return; }
  const maxQ = items.reduce((m,r)=>Math.max(m, r.responses?.length||0), 0);
  let thead = `<tr>
    <th>Alumne</th><th>Grup</th><th>Puntuació</th><th>Màx</th><th>%</th><th>Data</th>`;
  for(let i=1;i<=maxQ;i++) thead += `<th>Q${i}</th>`;
  thead += `</tr>`;
  let rows = '';
  items.forEach(r=>{
    const pct = r.totals?.max ? (100*r.totals.score/r.totals.max).toFixed(1) : '';
    let qs = '';
    (r.responses||[]).forEach(ans=>{
      const tag = ans.correct===true?'✅':(ans.correct===false?'❌':'—');
      qs += `<td title="${escapeHtml(ans.answer)}">${tag}</td>`;
    });
    for(let k=(r.responses||[]).length;k<maxQ;k++) qs += `<td>—</td>`;
    rows += `<tr>
      <td>${escapeHtml(r.student?.name||'')}</td>
      <td>${escapeHtml(r.student?.group||'')}</td>
      <td>${r.totals?.score??''}</td>
      <td>${r.totals?.max??''}</td>
      <td>${pct? pct+'%':''}</td>
      <td>${new Date(r.submittedAt).toLocaleString()}</td>
      ${qs}
    </tr>`;
  });
  tbl.innerHTML = `<thead>${thead}</thead><tbody>${rows}</tbody>`;
  $('#aggSummary').textContent = `${items.length} resultats`;
}
function downloadCSV(){
  const examId = ($('#examIdLookup').value||'').trim();
  if(!examId){ alert('Escriu un examId.'); return; }
  const a = document.createElement('a');
  a.href = `/api/results/${encodeURIComponent(examId)}/csv`;
  a.click();
}

/* ========= Biblioteca (mestre) ========= */
let libraryItems = [];
async function listExams() {
  try {
    const btn = $('#libRefreshBtn'); if(btn) btn.disabled = true;

    const subj = ($('#libSubjectFilter')?.value || '').trim();
    const q = ($('#libSearch')?.value || '').trim();
    const params = new URLSearchParams();
    if (subj) params.set('subject', subj);
    if (q) params.set('q', q);

    const res = await fetch(API_BASE + '/api/exams?' + params.toString());
    if(!res.ok) throw new Error('No s’ha pogut llistar exàmens');
    libraryItems = await res.json();
    renderLibrary(libraryItems);
    $('#libraryInfo').textContent = `${libraryItems.length} exàmens`;
  } catch (e) {
    $('#libraryInfo').innerHTML = `<span class="warn">${escapeHtml(e.message||'Error desconegut')}</span>`;
    $('#libraryTable').innerHTML = '';
  } finally {
    const btn = $('#libRefreshBtn'); if(btn) btn.disabled = false;
  }
}

function renderLibrary(items){
  const tbl = $('#libraryTable');
  if(!items.length){ tbl.innerHTML=''; return; }
  let thead = `<tr><th>Títol</th><th>PIN</th><th>examId</th><th>Creat</th><th>Accions</th></tr>`;
  let rows = '';
  items.forEach(x=>{
    rows += `<tr>
      <td>${escapeHtml(x.title||'')}</td>
      <td>${escapeHtml(x.pin||'')}</td>
      <td class="mono">${escapeHtml(x._id||'')}</td>
      <td>${escapeHtml(formatDate(x.createdAt||''))}</td>
      <td class="flex">
        <button class="btn small" onclick="loadExamById('${x._id}')">Carrega</button>
        <button class="btn small secondary" onclick="cloneExam('${x._id}')">Clona (nou PIN)</button>
        <button class="btn small secondary" onclick="copyToClipboard('${x.pin||''}')">Copia PIN</button>
        <button class="btn small bad" onclick="deleteExam('${x._id}')">🗑️ Elimina</button>
      </td>
    </tr>`;
  });
  tbl.innerHTML = `<thead>${thead}</thead><tbody>${rows}</tbody>`;
}
async function loadExamById(id){
  id = String(id||'').trim();
  if(!id){ alert('Falta examId'); return; }
  try{
    const res = await fetch(API_BASE + '/api/exams/' + encodeURIComponent(id));
    if(!res.ok) throw new Error('Examen no trobat (GET /api/exams/:id)');
    const data = await res.json();
    exam = data || { title:'', desc:'', settings:{showScoreToStudent:true, shuffle:false}, questions:[] };
    selectedQId = (exam.questions[0]||{}).id || null;
    $('#examTitle').value = exam.title || '';
    $('#examDesc').value  = exam.desc  || '';
    $('#examShowScore').value = (exam.settings && exam.settings.showScoreToStudent===false) ? 'no' : 'yes';
    $('#examShuffle').checked = !!(exam.settings && exam.settings.shuffle);
    renderAll();
    localStorage.setItem('focusSrv_exam', JSON.stringify(exam));
    toast('Examen carregat a l’editor');
    // passa a la pestanya Editor
    document.querySelector('.tab-btn[data-tab="tab-editor"]').click();
  }catch(e){
    alert('No s’ha pogut carregar l’examen: ' + (e.message||''));
  }
}
async function cloneExam(id){
  try{
    const res = await fetch(API_BASE + '/api/exams/' + encodeURIComponent(id));
    if(!res.ok) throw new Error('No s’ha trobat l’examen origen');
    const src = await res.json();
    const body = {
      title: src.title||'',
      desc: src.desc||'',
      subject: src.subject || '', 
      settings: src.settings||{showScoreToStudent:true, shuffle:false},
      questions: src.questions||[]
    };
    const res2 = await fetch(API_BASE + '/api/exams', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res2.ok) throw new Error(await res2.text());
    const data = await res2.json();
    toast(`Clonat! Nou PIN: ${data.pin}`);
    $('#examIdLookup').value = data.examId;
    listExams();
  }catch(e){
    alert('Error en clonar: ' + (e.message||''));
  }
}
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text||''); toast('Copiat'); }catch(_){ /* ignore */ }
}

/* ========= Afegit ràpid (modal) ========= */
function openQuickAddModal(){ $('#qaModal').style.display='flex'; $('#qaInput').focus(); }
function closeQuickAddModal(){ $('#qaModal').style.display='none'; }
function applyQuickAddModal(){
  const raw = ($('#qaInput').value||'').trim();
  if(!raw){ closeQuickAddModal(); return; }
  const lines = raw.split('\n').map(s=>s.trim()).filter(Boolean);
  lines.forEach(line=>{
    const [typePart, rest] = line.split(';');
    if(!rest) return;
    const type = (typePart||'').trim().toLowerCase();
    const chunks = rest.split('|').map(s=>s.trim()).filter(Boolean);
    const enunciat = chunks.shift() || '';
    if(type==='mc'){
      const opts = chunks.map(t=>{
        const correct = /\*$/.test(t);
        return {text: t.replace(/\*$/,''), correct};
      });
      if(!opts.some(o=>o.correct) && opts.length>0) opts[0].correct=true;
      exam.questions.push({id:uid(), type:'mc', text:enunciat, points:1, options:opts, tags:[], media:{}});
    } else if(type==='tf'){
      const v = (chunks[0]||'').toLowerCase();
      const correctIsTrue = v.startsWith('v');
      exam.questions.push({id:uid(), type:'tf', text:enunciat, points:1, options:[
        {text:'Vertader', correct:correctIsTrue},
        {text:'Fals', correct:!correctIsTrue}
      ], tags:[], media:{}});
    } else if(type==='short'){
      const ans = chunks.shift()||'';
      exam.questions.push({id:uid(), type:'short', text:enunciat, points:1, answerText:ans, accepts:chunks, tags:[], media:{}});
    } else if(type==='num'){
      const val = chunks.shift()||'';
      const tol = chunks.shift()||'0';
      exam.questions.push({id:uid(), type:'num', text:enunciat, points:1, numAnswer:val, tolerance:tol, tags:[], media:{}});
    } else if(type==='order'){
      exam.questions.push({id:uid(), type:'order', text:enunciat, points:1, items:chunks, tags:[], media:{}});
    } else if(type==='match'){
      const pairs = chunks.map(s=>s.split('-').map(x=>x.trim())).filter(p=>p.length===2);
      const left = pairs.map(p=>p[0]), right=pairs.map(p=>p[1]);
      exam.questions.push({id:uid(), type:'match', text:enunciat, points:1, left, right, tags:[], media:{}});
    }
  });
  selectedQId = (exam.questions[exam.questions.length-1]||{}).id || selectedQId;
  renderAll(); markDirty(); closeQuickAddModal();
}

/* ========= Init ========= */
function restoreExam(){
  try{
    const raw = localStorage.getItem('focusSrv_exam');
    if(raw){
      exam = JSON.parse(raw);
      $('#examTitle').value = exam.title||'';
      $('#examDesc').value = exam.desc||'';
      $('#examSubject').value = exam.subject || '';
      $('#examShowScore').value = exam.settings?.showScoreToStudent===false?'no':'yes';
      $('#examShuffle').checked = !!exam.settings?.shuffle;
      selectedQId = (exam.questions[0]||{}).id || null;
      renderAll();
    } else {
      renderAll();
    }
  }catch(e){ renderAll(); }
}
window.addEventListener('load', ()=>{ restoreExam(); });

/* ========= Eliminar examen ========= */
async function deleteExam(id) {
  if (!confirm('Segur que vols eliminar aquest examen?')) return;
  try {
    const res = await fetch(API_BASE + '/api/exams/' + encodeURIComponent(id), {
      method: 'DELETE'
    });
    if (!res.ok) throw new Error(await res.text());
    toast('Examen eliminat');
    listExams(); // refresca la biblioteca
  } catch (e) {
    alert('Error eliminant examen: ' + (e.message || ''));
  }
}
</script>
</body>
</html>
